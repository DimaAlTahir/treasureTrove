<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width"/>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="stylesheet.css">
    <title>TreasureTrove</title>
</head>
<body onload="setInterval(getLocation, 45000);">


<div id="scoreContainer">
    <h3 id="scoreDisplay"></h3>
</div>

<div id="messageContainer">
    <h4 id="message"></h4>
</div>

<div class="container2" >

    <div id="progressContainer">
        <h3 id="questionProgress"></h3>
    </div>

    <div id="quizQuestionContainer">
        <h4 id="question"></h4>  <!--Leave it empty -->
    </div>

    <div class="answer" id="textboxContainer">
        <form action="javascript:answerText()">
            <label for="textBox"></label>
            <input id="textBox" class="answer" type="text" name="answer" required>
            <div class="btns">
                <input id="buttonText" class="controlbtns" type="submit" value="Submit">
            </div>
        </form>
    </div>

    <div class="answer" id="numericContainer">
        <form action="javascript:answerNum()">
            <label for="number"></label>
            <input id="number" class="answer" type="number" step="any" name="answer" placeholder="Enter a number" required>
            <div class="btns">
                <input id="buttonNum" class="controlbtns" type="submit" value="Submit">
            </div>
        </form>
    </div>

    <div class="answer" id="intContainer">
        <form action="javascript:answerInt()">
            <label for="int"></label>
            <input id="int" class="answer" type="number" name="answer" placeholder="Enter a number" required>
            <div class="btns">
                <input id="buttonInt" class="controlbtns" type="submit" value="Submit">
            </div>
        </form>
    </div>

    <div class="answer" id="booleanContainer" >
        <div class="btns">
            <button id="buttonTrue" class="tnfButtons" value="True" onclick="loadAnswer('True')">True</button>
            <button id="buttonFalse" class="tnfButtons" value="False" onclick="loadAnswer('False')">False</button>
        </div>
    </div>

    <div id="MCQContainer" class="btns">
        <button id="buttonA" class="mqsButtons" value="A" onclick="loadAnswer('A')">A</button>
        <button id="buttonB" class="mqsButtons" value="B" onclick="loadAnswer('B')">B</button>
        <button id="buttonC" class="mqsButtons" value="C" onclick="loadAnswer('C')">C</button>
        <button id="buttonD" class="mqsButtons" value="D" onclick="loadAnswer('D')">D</button>
    </div>


</div>

<div id="skipContainer">
    <form action="javascript:skipQuestion()">
        <input class="controlbtns" id="buttonSkip" type="submit" value="Skip"/>
    </form>
</div>






<script>

    const API_SKIP = "https://codecyprus.org/th/api/skip";
    const API_SCORE = "https://codecyprus.org/th/api/score";
    const API_LOCATION = "https://codecyprus.org/th/api/location";
    const API_ANSWER = "https://codecyprus.org/th/api/answer";
    const API_QUESTIONS = "https://codecyprus.org/th/api/question";
    const API_START = "https://codecyprus.org/th/api/start";
    const params = new URLSearchParams(location.search);
    let playerName = params.get("player");
    let uuid = params.get("treasure-hunt-id");
    let lifeOfCookie = params.get("time");
    let nameOfGame =params.get("nameOfGame");


    function startGame() {
        document.getElementById("skipContainer").style.display="none";
        document.getElementById("question").innerText = "Loading....";
        document.getElementById("numericContainer").style.display = 'none';
        document.getElementById("intContainer").style.display = 'none';
        document.getElementById("textboxContainer").style.display = 'none';
        document.getElementById("booleanContainer").style.display = 'none';
        document.getElementById("MCQContainer").style.display = 'none';
        fetch(API_START + "?player=" + playerName + "&app=TreasureTrove&treasure-hunt-id=" + uuid)
            .then(response => response.json())
            .then(jsonObject => {
                console.log(jsonObject.status);
                if (jsonObject.status === "ERROR") {
                    document.getElementById("skipContainer").style.display="none";
                    document.getElementById("question").innerHTML = jsonObject.errorMessages[0] + "<br>" + "<a href='Signin.html'> Click this Link to Sign again</a>";
                } else if (jsonObject.status === "OK") {
                    saveCookie("playerName", playerName, lifeOfCookie);
                    saveCookie("sessionID", jsonObject.session, lifeOfCookie);
                    saveCookie("gameSaved", "true", lifeOfCookie);
                    saveCookie("nameOfGame", nameOfGame, lifeOfCookie);

                    document.getElementById("skipContainer").style.display="block";
                    getQuestions();
                }
            });
    }


    // Function that loads the question and the correct way to answer it
    function getQuestions() {
        document.getElementById("question").innerText = "Loading....";
        document.getElementById("numericContainer").style.display = 'none';
        document.getElementById("intContainer").style.display = 'none';
        document.getElementById("textboxContainer").style.display = 'none';
        document.getElementById("booleanContainer").style.display = 'none';
        document.getElementById("MCQContainer").style.display = 'none';
        document.getElementById("questionProgress").innerHTML="";

        fetch(API_QUESTIONS + "?session=" + getCookie("sessionID"))
            .then(response => response.json())
            .then(jsonObject => {
                console.log("getQuestion status: " + jsonObject.status);
                if (jsonObject.status === "ERROR") {
                    document.getElementById("question").innerHTML = jsonObject.errorMessages[0] + "<br>" + "<a href='Signin.html.html'> Click this Link to Sign again</a>";
                } else if (jsonObject.status === "OK") {
                    document.getElementById("question").innerHTML = "<p>" + jsonObject.questionText + "</p>";
                }

                if (jsonObject.requiresLocation === true)
                    getLocation();

                if (jsonObject.canBeSkipped === false) {
                    document.getElementById("skipContainer").style.display = 'none';
                } else {
                    document.getElementById("skipContainer").style.display = 'block';
                }

                if (jsonObject.completed === true) {
                    document.getElementById("message").innerHTML="";
                    document.getElementById("questionProgress").innerHTML = "";
                    document.getElementById("question").innerHTML="GAME ENDED";
                    setTimeout(function(){window.location.href = "Leaderboard.html?session=" + getCookie("sessionId") + "&sorted&limit=20";},1000);
                    //setInterval("countDown()", 1000);

                } else {
                    document.getElementById("questionProgress").innerHTML="Current Question " + (jsonObject.currentQuestionIndex+1) + " / "+ jsonObject.numOfQuestions;
                    switch (jsonObject.questionType) {
                        case "INTEGER":
                            console.log("INT=block");
                            document.getElementById("numericContainer").style.display = 'none';
                            document.getElementById("intContainer").style.display = 'block';
                            document.getElementById("textboxContainer").style.display = 'none';
                            document.getElementById("booleanContainer").style.display = 'none';
                            document.getElementById("MCQContainer").style.display = 'none';
                            break;

                        case "NUMERIC":
                            console.log("NUM=block");
                            document.getElementById("numericContainer").style.display = 'block';
                            document.getElementById("intContainer").style.display = 'none';
                            document.getElementById("textboxContainer").style.display = 'none';
                            document.getElementById("booleanContainer").style.display = 'none';
                            document.getElementById("MCQContainer").style.display = 'none';
                            break;

                        case "BOOLEAN":
                            console.log("BOOLEAN=block");
                            document.getElementById("numericContainer").style.display = 'none';
                            document.getElementById("intContainer").style.display = 'none';
                            document.getElementById("textboxContainer").style.display = 'none';
                            document.getElementById("booleanContainer").style.display = 'block';
                            document.getElementById("MCQContainer").style.display = 'none';
                            break;

                        case "MCQ":
                            console.log("MCQ=block");
                            document.getElementById("numericContainer").style.display = 'none';
                            document.getElementById("intContainer").style.display = 'none';
                            document.getElementById("textboxContainer").style.display = 'none';
                            document.getElementById("booleanContainer").style.display = 'none';
                            document.getElementById("MCQContainer").style.display = 'block';
                            break;

                        case "TEXT":
                        default:
                            console.log("textbox=block");
                            document.getElementById("numericContainer").style.display = 'none';
                            document.getElementById("intContainer").style.display = 'none';
                            document.getElementById("textboxContainer").style.display = 'block';
                            document.getElementById("booleanContainer").style.display = 'none';
                            document.getElementById("MCQContainer").style.display = 'none';
                            break;
                    }
                }
                getScore();
            });
    }



    //functions to find device location
    function getLocation() {
        console.log("getLocation...");
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                sendLocation(position.coords.latitude, position.coords.longitude);
            });
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    }


    function sendLocation(lat, lng) {
        console.debug("lat: " + lat + ", lng: " + lng);
        fetch(API_LOCATION + "?session=" + getCookie("sessionID") + "&latitude=" + lat + "&longitude=" + lng)
            .then(response => response.json())
            .then(jsonObject => {
                console.debug("/location -> " + jsonObject); // must be removed later
            });
    }

    function answerText() {
        let answer = document.getElementById("textBox").value;
        loadAnswer(answer);

    }

    function answerNum() {
        let answer = document.getElementById("number").value;
        loadAnswer(answer);
    }

    function answerInt() {
        let answer = document.getElementById("int").value;
        loadAnswer(answer);
    }

    function loadAnswer(answer) {
        document.getElementById("number").value="";
        document.getElementById("textBox").value="";
        document.getElementById("int").value="";
        document.getElementById("message").innerHTML = "";
        console.debug("submitted: " + answer);
        fetch(API_ANSWER + "?session=" + getCookie("sessionID") + "&answer=" + answer)
            .then(response => response.json())
            .then(jsonObject => {
                console.log("loadAnswer status: " + jsonObject.status);

                if (jsonObject.status === "ERROR") {
                    console.log("There was an error with the answer sent to the server");
                    document.getElementById("message").innerHTML= jsonObject.errorMessages[0] + "<br>" + "<a href='Signin.html?finished'> Click this Link to Sign again</a>";

                } else if ((jsonObject.status === "OK") && (jsonObject.correct === true)) {
                    document.getElementById("message").innerHTML = jsonObject.message + " You gained " + jsonObject.scoreAdjustment + " points.";
                } else if ((jsonObject.status === "OK") && (jsonObject.correct === false)) {
                    document.getElementById("message").innerHTML = jsonObject.message + " You lost " + jsonObject.scoreAdjustment + " points.";
                }
                getQuestions();
            });
    }

    //function to skip questions
    function skipQuestion() {
        document.getElementById("message").innerHTML = "";
        fetch(API_SKIP + "?session=" + getCookie("sessionID"))
            .then(response => response.json())
            .then(jsonObject => {
                if (jsonObject.status === "OK") {
                    if (jsonObject.completed === false) {
                        document.getElementById("message").innerHTML = "Question " + jsonObject.message + " You Lost : " + jsonObject.scoreAdjustment;
                    }
                } else if (jsonObject.status === "ERROR") {
                    document.getElementById("message").innerHTML = jsonObject.errorMessages[0];
                }
                getQuestions();
            });
    }


    // Function to get the score
    function getScore() {
        document.getElementById("scoreContainer").style.display = "none";
        fetch(API_SCORE + "?session=" + getCookie("sessionID"))
            .then(response => response.json())
            .then(jsonObject => {
                if (jsonObject.status === "OK")
                    if ((jsonObject.completed === false) && (jsonObject.finished === false)) {
                        document.getElementById("scoreDisplay").innerHTML = "Score is: " + jsonObject.score + " Points.";
                        document.getElementById("scoreContainer").style.display = "block";
                    } else if(jsonObject.completed) {
                        document.getElementById("scoreDisplay").innerHTML = ""; //+ getCookie("playerName") + " your Score is: " + jsonObject.score + " Points.";
                        document.getElementById("scoreContainer").style.display = "block";
                    }
            });
    }

    function saveCookie(cookieName, cookieValue, expireHours) {
        let d = new Date();
        d.setTime(d.getTime() + (expireHours * 60 * 60 * 1000));
        let expires = "expires=" + d.toUTCString();
        document.cookie = cookieName + "=" + cookieValue + ";" + expires;
    }

    function getCookie(cookieName) {
        let name = cookieName + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) === 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    let current_count= 7;
    function countDown() {
        document.getElementById("questionProgress").innerHTML = "Redirecting in.. " + current_count;
        if ( current_count > 0 ) { current_count--; }
        else {
            clearInterval(countJob);
            document.getElementById("questionProgress").innerHTML = "";
        }
    }



    if ((getCookie("gameSaved") === "true") && (getCookie("playerName") === playerName)) {
        getQuestions();
        //continueGame();
    } else startGame();




</script>


</body>
</html>