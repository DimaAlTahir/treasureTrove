<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width"/>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="stylesheet.css">
    <title>Title</title>

</head>
<body>

 <div class="container">

     <div id="quizQuestionContainer">
         <h4 id="question"></h4>  <!--Leave it empty -->
     </div>

     <div class="answer" id="textboxContainer">
         <form action="javascript:answerText()">
             <input id="textBox" class="answer" type="text" name="answer">
             <input id="buttonText" class="controlbtns" type="submit" value="Submit">
         </form>
      </div>

     <div class="answer" id="numericContainer">
         <form action="javascript:answerNum()">
             <input id="number" class="answer" type="number" name="answer">
             <input id="buttonNum" class="controlbtns" type="submit" value="Submit">
         </form>
     </div>

     <div class="answer" id="intContainer">
         <form action="javascript:answerInt()">
             <input id="int" class="answer" type="number" name="answer">
             <input id="buttonInt" class="controlbtns" type="submit" value="Submit">
         </form>
     </div>

     <div class="answer" id="booleanContainer">
             <button id="buttonTrue" class="controlbtns" value="True" onclick="loadAnswer('True')">True</button>
             <button id="buttonFalse" class="controlbtns" value="False" onclick="loadAnswer('False')">False</button>
     </div>

     <div class="answer" id="MCQContainer">
         <button id="buttonA" class="controlbtns" value="A" onclick="loadAnswer('A')">A</button>
         <button id="buttonB" class="controlbtns" value="B" onclick="loadAnswer('B')">B</button>
         <button id="buttonC" class="controlbtns" value="C" onclick="loadAnswer('C')">C</button>
         <button id="buttonD" class="controlbtns" value="D" onclick="loadAnswer('D')">D</button>
     </div>

 </div>


 <div id="skipContainer">
     <form  action="javascript:skipQuestion()">
         <input class="answer"  id="buttonSkip" type="submit" value="Skip" />
     </form>
 </div>

 <div id="messageContainer">
        <h3 id="message"></h3>
 </div>

<script>
    const API_LOCATION="https://codecyprus.org/th/api/location";
    const API_ANSWER="https://codecyprus.org/th/api/answer";
    const API_QUESTIONS="https://codecyprus.org/th/api/question";
    const API_START="https://codecyprus.org/th/api/start";
    const params = new URLSearchParams(location.search);
    let playerName = params.get("player");
    let uuid = params.get("treasure-hunt-id");
    console.log("playerName:"+playerName);
    console.log("uuid:"+uuid);

    startGame();

    function startGame(){
        document.getElementById("question").innerText="Loading....";
        fetch(API_START + "?player="+playerName+"&app=TreasureTrove&treasure-hunt-id="+uuid)
            .then(response => response.json())
            .then(jsonObject =>
            {
                console.log(jsonObject.status);
                if (jsonObject.status ==="ERROR"){
                    document.getElementById("question").innerHTML= jsonObject.errorMessages[0] + "<br>" + "<a href='Signin.html'> Click this Link to Sign again</a>";
                }else if(jsonObject.status ==="OK"){
                    saveCookie("sessionID",jsonObject.session,360);
                    saveCookie("numOfQuestions",jsonObject.numOfQuestions,360);
                    // console.log( getCookie("sessionID"));
                    // console.log( getCookie("numOfQuestions"));
                    getQuestions();
                }

            });
    }

    // Function that loads the question and the correct way to answer it
    function getQuestions(){
        fetch(API_QUESTIONS+"?session="+getCookie("sessionID"))
            .then(response => response.json())
            .then(jsonObject =>
            {
                console.log("getQuestion status: "+jsonObject.status);
                if (jsonObject.status ==="ERROR"){
                    document.getElementById("question").innerHTML= jsonObject.errorMessages[0] + "<br>" + "<a href='Signin.html'> Click this Link to Sign again</a>";
                }else if(jsonObject.status ==="OK"){
                    document.getElementById("question").innerHTML= "<p>"+ jsonObject.questionText +"</p>";

                    if (jsonObject.requiresLocation === true)
                        sendLocation();

                    if (jsonObject.canBeSkipped === true){
                        document.getElementById("skipContainer").style.display='none';
                    } else document.getElementById("skipContainer").style.display='block';

                    switch (jsonObject.questionType) {
                        case "INTEGER":
                            document.getElementById("numericContainer").style.display='none';
                            document.getElementById("intContainer").style.display='block';
                            document.getElementById("textboxContainer").style.display='none';
                            document.getElementById("booleanContainer").style.display='none';
                            document.getElementById("MCQContainer").style.display='none';
                            break;

                        case "NUMERIC":
                            document.getElementById("numericContainer").style.display='block';
                            document.getElementById("intContainer").style.display='none';
                            document.getElementById("textboxContainer").style.display='none';
                            document.getElementById("booleanContainer").style.display='none';
                            document.getElementById("MCQContainer").style.display='none';
                            break;

                        case "BOOLEAN":
                            document.getElementById("numericContainer").style.display='none';
                            document.getElementById("intContainer").style.display='none';
                            document.getElementById("textboxContainer").style.display='none';
                            document.getElementById("booleanContainer").style.display='block';
                            document.getElementById("MCQContainer").style.display='none';
                            break;

                        case "MCQContainer":
                            document.getElementById("numericContainer").style.display='none';
                            document.getElementById("intContainer").style.display='none';
                            document.getElementById("textboxContainer").style.display='none';
                            document.getElementById("booleanContainer").style.display='none';
                            document.getElementById("MCQContainer").style.display='block';
                            break;

                        case "TEXT":
                            document.getElementById("numericContainer").style.display='none';
                            document.getElementById("intContainer").style.display='none';
                            document.getElementById("textboxContainer").style.display='none';
                            document.getElementById("booleanContainer").style.display='block';
                            document.getElementById("MCQContainer").style.display='none';
                    }
                }
            });
    }



    // {
    //     "session": "ag9nfmNvZGVjeXBydXNvcmdyFAsSB1Nlc3Npb24YgICA3JfiuQsM",
    //     "numOfQuestions": 6,
    //     "status": "OK"
    // }


    //functions to find device location
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        }
        else {
            alert("Geolocation is not supported by your browser.");
        }
    }
    function showPosition(position) {
        return ("&latitude=" + position.coords.latitude + "&Longitude=" + position.coords.longitude);
    }

    // function sentLocation() {
    //     fetch(API_LOCATION + "?session=" + getCookie("sessionID") + getLocation())
    //         .then(response => response.json())
    //         .then(jsonObject => {
    //
    //         });
    // }



    //function to skip questions
    // function skipQuestion() {
    //     fetch("https://codecyprus.org/th/api/question")
    //         .then(response => response.json())
    //         .then(jsonObject => {
    //             let current = jsonObject.currentQuestionIndex;
    //             for (let i = 0; i < treasureHuntsArray.length; i++) {
    //                 if (numOfQuestions[i] === current) {
    //                     continue;
    //                 }
    //             }
    //         });
    // }

    //function that writes question then decides the way 2 answer
    // function displayQuestionReply(){
    //     document.getElementsById(question).innerHTML=json.questionText;
    //     if (json.questionType==='BOOLEAN'){
    //         document.getElementById(submitBtn).style.display='none';
    //         document.getElementById(boolBtnT).style.display='grid';
    //         document.getElementById(boolBtnF).style.display='grid';
    //     }
    //     else if (json.questionType ==='TEXT'){
    //         document.getElementById(submitBtn).style.display='grid';
    //         document.getElementById(boolBtnT).style.display='none';
    //         document.getElementById(boolBtnF).style.display='none';
    //     }
    //     else if (json.questionType==='INTEGER'){
    //         document.getElementById(submitBtnInt).style.display='grid';
    //         document.getElementById(submitBtn).style.display='none';
    //         document.getElementById(boolBtnT).style.display='none';
    //         document.getElementById(boolBtnF).style.display='none';
    //     }
    //     else if (json.questionType==='NUMERIC'){
    //         document.getElementById(submitBtnNumeric).style.display='grid';
    //         document.getElementById(submitBtnInt).style.display='none';
    //         document.getElementById(submitBtn).style.display='none';
    //         document.getElementById(boolBtnT).style.display='none';
    //         document.getElementById(boolBtnF).style.display='none';
    //     }
    //     else{
    //         document.getElementById(submitBtnNumeric).style.display='none';
    //         document.getElementById(submitBtnInt).style.display='none';
    //         document.getElementById(submitBtn).style.display='none';
    //         document.getElementById(boolBtnT).style.display='none';
    //         document.getElementById(boolBtnF).style.display='none';
    //     }
    //
    // }

    function answerText(){
        let answer=document.getElementById("textBox").value;
        loadAnswer(answer);
    }

    function answerNum(){
        let answer=document.getElementById("number").value;
        loadAnswer(answer);
    }

    function answerInt(){
        let answer=document.getElementById("int").value;
        loadAnswer(answer);
    }

    // function trueAns(){
    //     loadAnswer('true');
    // }
    // function falseAns(){
    //     loadAnswer('false');
    // }

    function loadAnswer(answer){
        console.debug("submitted: "+answer);
        fetch(API_ANSWER + "?session=" + getCookie("sessionID") + "&answer=" + answer)
            .then(response => response.json())
            .then(jsonObject => {
                console.log("loadAnswer status: "+jsonObject.status);

                if (jsonObject.status ==="ERROR"){
                    document.getElementById("question").innerHTML= jsonObject.errorMessages[0] + "<br>" + "<a href='Signin.html'> Click this Link to Sign again</a>";

                } else if ((jsonObject.status ==="OK") && (jsonObject.correct === true)){
                    document.getElementById("message").innerHTML= jsonObject.message + "you gained: " + jsonObject.scoreAdjustment + " points.";
                } else if ((jsonObject.status ==="OK") && (jsonObject.correct === false)) {
                    document.getElementById("message").innerHTML= jsonObject.message + "you lost: " + jsonObject.scoreAdjustment + " points.";


                }
            });
    }

    function saveCookie(cookieName, cookieValue, expireDays) {
        let d = new Date();
        d.setTime(d.getTime() + (expireDays*24*60*60*1000));
        let expires = "expires="+ d.toUTCString();
        document.cookie = cookieName + "=" + cookieValue + ";" + expires;
    }

    function getCookie(cookieName) {
        let name = cookieName + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for(let i = 0; i <ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) === 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
</script>




</body>
</html>