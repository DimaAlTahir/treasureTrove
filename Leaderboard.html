<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width"/>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="stylesheet.css">
    <title>Leaderboard</title>
</head>

<body onload="checkIfTest();">
<h2>Leaderboards</h2>
<div id="scoreContainer">
    <h3 id="scoreDisplay"></h3>
</div>


<div id="priceContainer">
    <h3 id="priceDisplay"></h3>
</div>

<div class="container" >
    <h3 id="endMessage">loading...</h3>
    <table id="LeaderboardTable">
        <tr>
            <th><b>Name</b></th>
            <th><b>Score</b></th>
            <th><b>Time</b></th>
        </tr>
    </table>
</div>


<script>
    const API_TEST_LEADERBOARD = "https://codecyprus.org/th/test-api/";
    const API_LEADERBOARD = "https://codecyprus.org/th/api/";
    const API_SCORE = "https://codecyprus.org/th/api/score";
    let leaderboardElement= document.getElementById("LeaderboardTable");
    let html = "";
    const params = new URLSearchParams(location.search);




    function getLeaderboard(url){
        fetch(url)
            .then(response => response.json())
            .then(jsonObject =>
            {
                document.getElementById("endMessage").style.display = "none";
                let leaderboardArray =jsonObject.leaderboard;
                for (let i = 0; i < jsonObject.limit; i++) {
                    html +=
                                "<tr>\n" +
                                "    <td>" + leaderboardArray[i].player + "</td>" +
                                "    <td>" + leaderboardArray[i].score + "</td>" +
                                "    <td>" + convert2date(leaderboardArray[i].completionTime) + "</td>" +
                                "</tr>";
                }
                leaderboardElement.innerHTML +=html;

                getScore();
                if (jsonObject.hasPrize === true) {
                   setTimeout(function(){document.getElementById("priceDisplay").innerHTML="Congratulations you won a price "}, 1000);
                }
            });
    }

    function getScore() {
        document.getElementById("scoreContainer").style.display = "none";
        fetch(API_SCORE + "?session=" + getCookie("sessionID"))
            .then(response => response.json())
            .then(jsonObject => {
                if (jsonObject.status === "OK"){
                    console.log("status get score OK");
                    if ((jsonObject.completed === false) && (jsonObject.finished === false)) {
                        document.getElementById("scoreDisplay").innerHTML = "Score is: " + jsonObject.score;
                        document.getElementById("scoreContainer").style.display = "block";

                    } else if(jsonObject.completed) {
                        document.getElementById("scoreDisplay").innerHTML = "The Game has ended " + "<span style='font-style: italic'>"
                            + getCookie("playerName")+"</span>" + " and your Score is " + jsonObject.score +" Points. ";
                        document.getElementById("scoreContainer").style.display = "block";

                    }
                }
            });
    }
    options = { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit',
        second: '2-digit' };

    function convert2date(ms) {
        let date = new Date(ms);
        return date.toLocaleDateString((options));
    }

    function getCookie(cookieName) {
        let name = cookieName + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) === 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }


    function checkIfTest() {
        if(isTest()) {
            // recuires a size and a sorted variable
            let bSorted =params.has("sorted");
            let size = params.get("size");
            let url = API_TEST_LEADERBOARD + "leaderboard?size=" + size + "&sorted=" + bSorted;
            getLeaderboard(url);
        } else {
            // form the actual TH service url
            let session = getCookie("sessionID");
            let url = API_LEADERBOARD + "leaderboard?sorted&session=" + session +"&sorted&limit=20"; // form url
            getLeaderboard(url);
        }
    }

    function isTest() {
        let url = new URL(window.location.href);
        return url.searchParams.get("test") != null;
    }



</script>

</body>

</html>