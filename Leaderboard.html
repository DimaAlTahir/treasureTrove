<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width"/>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="stylesheet.css">
    <title>Leaderboard</title>
</head>

<body onload="getLeaderboard();">
<h2>Leaderboards</h2>
<div id="scoreContainer">
    <h3 id="scoreDisplay"></h3>
</div>

<div id="priceContainer">
    <h3 id="priceDisplay"></h3>
</div>

<div class="container" >
    <h3 id="endMessage">loading...</h3>
    <ol id="leaderboard"></ol>
</div>


<script>
    const API_LEADERBOARD = "https://codecyprus.org/th/api/leaderboard";
    const API_SCORE = "https://codecyprus.org/th/api/score";
    let leaderboardElement= document.getElementById("leaderboard");


    function getLeaderboard(){
        fetch(API_LEADERBOARD+"?session="+getCookie("sessionID")+"&sorted&limit=20")
            .then(response => response.json())
            .then(jsonObject =>
            {
                document.getElementById("endMessage").style.display = "none";
                let leaderboardArray =jsonObject.leaderboard;
                for (let i = 0; i < jsonObject.limit; i++) {
                    let listleaderboard = document.createElement("li");
                    listleaderboard.innerHTML = "<b>Name: </b>" + leaderboardArray[i].player + "<br><b> Score: </b>" + leaderboardArray[i].score + "<br>" +
                        "<b> Completed in: </b>" + convert2date(leaderboardArray[i].completionTime);
                    leaderboardElement.appendChild(listleaderboard);

                }
                getScore();
                if (jsonObject.hasPrize === true) {
                   setTimeout(function(){document.getElementById("priceDisplay").innerHTML="Congratulations you won a price "}, 1000);
                }
            });
    }

    function getScore() {
        document.getElementById("scoreContainer").style.display = "none";
        fetch(API_SCORE + "?session=" + getCookie("sessionID"))
            .then(response => response.json())
            .then(jsonObject => {
                if (jsonObject.status === "OK"){
                    console.log("status get score OK");
                    if ((jsonObject.completed === false) && (jsonObject.finished === false)) {
                        document.getElementById("scoreDisplay").innerHTML = "Score is: " + jsonObject.score;
                        document.getElementById("scoreContainer").style.display = "block";
                        console.log("status completed false");
                    } else if(jsonObject.completed) {

                        document.getElementById("scoreDisplay").innerHTML = "Great job " + getCookie("playerName") + " your Score is: " + jsonObject.score +" Points. ";
                        document.getElementById("scoreContainer").style.display = "block";
                        console.log("status complete true");
                    }
                }
            });
    }

    function convert2date(ms){
        let date = new Date(ms);
        return date.toString();
    }

    function getCookie(cookieName) {
        let name = cookieName + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) === 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }// const params = new URLSearchParams(location.search);


</script>

</body>

</html>